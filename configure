#! /bin/sh


# The called program name, i.e. configure with its path
PROGNAME=$0

# Default board name:
BOARDNAME=vexpress-a9

# Directory where the configure script is
CURDIR=$(realpath $(dirname ${PROGNAME}))

# Script directory
SCRIPTDIR=${CURDIR}/scripts

# Make file directory
MAKEDIR=${CURDIR}/make

# Configuration file directory
CONFDIR=${CURDIR}/conf

# Build directory, used by this script to write the resulting configuration
# (the next variable)
BUILDDIR=${CURDIR}/build

# Temporary file directory
TMPDIR=/tmp/xvisor_env-$(date "+%Y%m%d-%H%M%S")

# Downloaded archive directory
ARCDIR=${BUILDDIR}/archives

# Build stamp directory
STAMPDIR=${BUILDDIR}/stamps

# The target built rootfs
TARGETDIR=${BUILDDIR}/target

# The resulting configuration
CONF=${BUILDDIR}/.env_config

# Does the board require busybox
BOARD_BUSYBOX=1

# Does the board will run under Qemu
BOARD_QEMU=0

# Verbosity option, that can be modify through the program arguments
VERBOSE=0


# Tool function used in this script
source ${SCRIPTDIR}/common.sh

board_list() {
    RET=$1

    if [ -z "${RET}" ]; then
	RET=1
    fi

    if [ ${RET} -eq 1 ]; then
	OUTPUT=/dev/stderr
    else
	OUTPUT=/dev/stdout
    fi

    printf "${BOLD}Available board support:${NORMAL}\n"
    printf "  - vexpress-a9:\tARM Versatile Express A9\n"
    printf "\t\t\tThe reference platform to emulate the hypervisor.\n"
    printf "  - nitrogen6x:\t\tBoundary Devices Nitrogen6x platform\n"
    printf "\t\t\tThe real board to run the hypervisor on.\n"

    exit ${RET}
}

option_board() {
    BOARD_CONF="${CONFDIR}/${BOARDNAME}.conf"
    print "Sourcing \"${BOARD_CONF}\"\n"
    source ${BOARD_CONF}
    source ${CONFDIR}/${ARCH}.conf
    source ${CONFDIR}/components.conf

    for elt in BUSYBOX UBOOT LOADER; do
	BOARD_ELT=BOARD_${elt}
	if [ ${!BOARD_ELT} -eq 1 ]; then
	    COMPONENTS="${COMPONENTS} ${elt}"
	fi
    done
}

option_check() {
    INSTALL_DEBIAN=""
    INSTALL_GENTOO="emerge -av --quiet-build"
    NCURSE_TMP="${TMPDIR}/ncurse_tmp"

    # Checking that Qemu is installed
    if [ ${BOARD_QEMU} -eq 1 ]; then
	which qemu-system-${QEMU_ARCH} &>/dev/null
	if [ $? -ne 0 ]; then
	    INSTALL_DEBIAN="qemu"
	    INSTALL_GENTOO="QEMU_SOFTMMU_TARGETS=${QEMU_ARCH} ${INSTALL_GENTOO}"
	    INSTALL_GENTOO="${INSTALL_GENTOO} app-emulation/qemu"
	fi
    fi

    # Checking that fakeroot, used by Busybox, is installed
    if [ ${BOARD_BUSYBOX} -eq 1 ]; then
	which fakeroot &>/dev/null
	if [ $? -ne 0 ]; then
	    INSTALL_DEBIAN="${INSTALL_DEBIAN} fakeroot"
	    INSTALL_GENTOO="${INSTALL_GENTOO} sys-apps/fakeroot"
	fi
    fi

    # Check the tool required to create the rootfs image
    TOOL=
    ROOTFS_IMG_SUFFIX=$(echo ${ROOTFS_IMG} | sed -re 's|.*\.(.+)|\1|')
    case ${ROOTFS_IMG_SUFFIX} in
	(ext2)
	    TOOL=genext2fs
	    DEBIAN_PKG=genext2fs
	    GENTOO_PKG=sys-fs/genext2fs
	    ;;
	(*)
	    printf "Unknown suffix \"${ROOTFS_IMG_SUFFIX}\" in the rootfs image "
	    echo "name \"${ROOTFS_IMG}\", exiting..."
	    exit 1
    esac
    if [ -n "${TOOL}" ]; then
	which "${TOOL}" &>/dev/null
	if [ $? -ne 0 ]; then
	    INSTALL_DEBIAN="${INSTALL_DEBIAN} ${DEBIAN_PKG}"
	    INSTALL_DEBIAN="${INSTALL_GENTOO} ${GENTOO_PKG}"
	fi
    fi

    # Checking that Ncurses is installed
    mkdir -p $(dirname ${NCURSE_TMP})
    cat > ${NCURSE_TMP}.c <<-EOF
	#include <curses.h>

	int main()
	{
	  return 0;
	}
	EOF
    gcc -lncurses ${NCURSE_TMP}.c -o ${NCURSE_TMP} &>/dev/null
    if [ $? -ne 0 ]; then
	INSTALL_DEBIAN="${INSTALL_DEBIAN} libncurses5-dev"
	INSTALL_GENTOO="${INSTALL_GENTOO} \">=sys-libs/ncurses-5\""
    fi
    rm -f ${NCURSE_TMP} ${NCURSE_TMP}.c

    # Display a summary if required
    if [ -n "${INSTALL_DEBIAN}" ]; then
	printf "${BOLD}Please install the following packages before "
	printf "continuing:${NORMAL}\n"
	printf "${BOLD}For Debian/Ubuntu:${NORMAL}\n"
	printf "  sudo apt-get install ${INSTALL_DEBIAN}\n"
	printf "${BOLD}For Gentoo:${NORMAL}\n"
	printf "  sudo ${INSTALL_GENTOO}\n"
	exit 1
    fi
}

config_write() {
    print "${BOLD}Components:${NORMAL} ${COMPONENTS}\n"

    mkdir -p $(dirname ${CONF})

    echo "# Configuration generated on $(date)" > ${CONF}
    echo "# by ${USER} on ${HOSTNAME}" >> ${CONF}
    printf "\n\n" >> ${CONF}

    echo "# File server" >> ${CONF}
    echo "FILE_SERVER=${FILE_SERVER}" >> ${CONF}
    printf "\n\n" >> ${CONF}

    echo "# Environment configuration" >> ${CONF}
    echo "COMPONENTS=\"${COMPONENTS}\"" >> ${CONF}
    for elt in CURDIR MAKEDIR SCRIPTDIR BUILDDIR TARGETDIR ARCDIR STAMPDIR\
	TMPDIR CONFDIR ROOTFS_IMG QEMU_IMG BUILD_VERBOSE BUILD_DEBUG; do
	echo "${elt}=${!elt}" >> ${CONF}
    done
    printf "\n\n" >> ${CONF}

    echo "# Board configuration" >> ${CONF}
    for elt in BOARDNAME ARCH QEMU_ARCH BOARD_BUSYBOX BOARD_QEMU BOARD_LOADER \
	BOARD_UBOOT TOOLCHAIN_PREFIX; do
	echo "${elt}=${!elt}" >> ${CONF}
    done

    printf "\n\n# Components\n" >> ${CONF}
    for component in ${COMPONENTS}; do
	COMPONENT_VERSION=${component}_VERSION
	COMPONENT_PATH=${component}_PATH
	COMPONENT_CONF=${component}_CONF
	COMPONENT_FILE=${component}_FILE
	COMPONENT_REPO=${component}_REPO
	COMPONENT_BRANCH=${component}_BRANCH

	echo "${COMPONENT_VERSION}=${!COMPONENT_VERSION}" >> ${CONF}
	echo "${COMPONENT_PATH}=${!COMPONENT_PATH}" >> ${CONF}
	echo "${COMPONENT_CONF}=${!COMPONENT_CONF}" >> ${CONF}

	# If the component is on a git repository, get its path...
	if [ -n "${!COMPONENT_REPO}" ]; then
	    echo "${COMPONENT_REPO}=${!COMPONENT_REPO}" >> ${CONF}
	    # ... and its branch
	    if [ -n "${!COMPONENT_BRANCH}" ]; then
		echo "${COMPONENT_BRANCH}=${!COMPONENT_BRANCH}" >> ${CONF}
	    else
		echo "${COMPONENT_REPO}=master" >> ${CONF}
	    fi
	# Otherwise, it is provided with a archive file
	else
	    echo "${COMPONENT_FILE}=${!COMPONENT_FILE}" >> ${CONF}
	fi
	echo >> ${CONF}
    done
}

option_parse $*
option_board
option_check
config_write
